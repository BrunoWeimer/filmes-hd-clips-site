<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebPlayer Premium</title>
    <style>
        :root {
            --primary: #3498db;
            --dark: #2c3e50;
            --light: #ecf0f1;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f5f5f5;
            color: #333;
        }
        .login-container {
            max-width: 500px;
            margin: 50px auto;
            padding: 30px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
        }
        .player-container {
            display: none;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        #videoPlayer {
            width: 100%;
            height: 500px;
            background: black;
            border-radius: 5px;
        }
        .channel-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        .channel-card {
            background: white;
            border-radius: 5px;
            padding: 10px;
            cursor: pointer;
            transition: transform 0.2s;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .channel-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        .channel-logo {
            width: 100%;
            height: 100px;
            object-fit: contain;
        }
        input, button {
            width: 100%;
            padding: 12px;
            margin: 10px 0;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
        }
        button {
            background: var(--primary);
            color: white;
            border: none;
            cursor: pointer;
            font-weight: bold;
            transition: background 0.3s;
        }
        button:hover {
            background: #2980b9;
        }
        .header {
            background: var(--dark);
            color: white;
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .category-filter {
            margin: 20px 0;
        }
    </style>
</head>
<body>
    <div class="login-container" id="loginSection">
        <h2>Acesse Seu IPTV</h2>
        <input type="text" id="username" placeholder="Usuário">
        <input type="password" id="password" placeholder="Senha">
        <button id="btn-login">Entrar</button>
        <div id="loginMessage" style="color:red; margin-top:10px;"></div>
    </div>

    <div class="player-container" id="playerSection">
        <div class="header">
            <h2>WebPlayer Premium</h2>
            <div>
                <span id="userInfo"></span>
                <button onclick="logout()" style="margin-left:10px;">Sair</button>
            </div>
        </div>
        
        <div class="video-container">
            <video id="videoPlayer" controls></video>
        </div>
        
        <div class="category-filter">
            <select id="categoryFilter" onchange="filterChannels()">
                <option value="all">Todos os Canais</option>
                <!-- Categorias serão carregadas dinamicamente -->
            </select>
        </div>
        
        <div class="channel-list" id="channelList">
            <!-- Canais serão carregados dinamicamente -->
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <script>
        const IPTV_PLAYER = {
            config: {
                server: "meuservidor.xyz",
                port: "80",
                protocol: window.location.protocol === "https:" ? "https://" : "http://"
            },
            
            init() {
                this.bindEvents();
                this.checkSavedCredentials();
            },
            
            bindEvents() {
                document.getElementById('btn-login').addEventListener('click', () => this.authenticate());
            },
            
            checkSavedCredentials() {
                const savedUser = localStorage.getItem('iptv_username');
                if (savedUser) {
                    document.getElementById('username').value = savedUser;
                    document.getElementById('password').focus();
                }
            },
            
            async authenticate() {
                const username = document.getElementById('username').value;
                const password = document.getElementById('password').value;
                
                if (!username || !password) {
                    this.showMessage('Por favor, preencha usuário e senha');
                    return;
                }
                
                this.showMessage('Conectando...', 'blue');
                
                try {
                    // Primeiro tenta autenticar via API
                    const authUrl = `${this.config.protocol}${this.config.server}:${this.config.port}/player_api.php?username=${username}&password=${password}`;
                    const response = await fetch(authUrl);
                    
                    if (!response.ok) throw new Error('Credenciais inválidas');
                    
                    const data = await response.json();
                    
                    if (data.user_info) {
                        // Salva credenciais (em um sistema real, use métodos mais seguros)
                        localStorage.setItem('iptv_username', username);
                        
                        // Carrega o player
                        this.loadPlayer(data.user_info, username, password);
                    } else {
                        throw new Error('Resposta inválida do servidor');
                    }
                } catch (error) {
                    console.error('Erro na autenticação:', error);
                    this.showMessage('Falha no login. Verifique suas credenciais.');
                }
            },
            
            loadPlayer(userInfo, username, password) {
                // Esconde login, mostra player
                document.getElementById('loginSection').style.display = 'none';
                document.getElementById('playerSection').style.display = 'block';
                
                // Exibe info do usuário
                document.getElementById('userInfo').textContent = `Bem-vindo, ${userInfo.username} (${userInfo.status})`;
                
                // Carrega lista de canais
                this.loadChannelList(username, password);
                
                // Carrega categorias
                this.loadCategories(username, password);
            },
            
            async loadChannelList(username, password) {
                try {
                    const m3uUrl = `${this.config.protocol}${this.config.server}:${this.config.port}/get.php?username=${username}&password=${password}&type=m3u_plus`;
                    const response = await fetch(m3uUrl);
                    const m3uContent = await response.text();
                    
                    this.parseM3U(m3uContent);
                } catch (error) {
                    console.error('Erro ao carregar canais:', error);
                    this.showMessage('Erro ao carregar lista de canais', 'red');
                }
            },
            
            parseM3U(m3uContent) {
                const lines = m3uContent.split('\n');
                const channelList = document.getElementById('channelList');
                channelList.innerHTML = '';
                
                let currentChannel = {};
                
                lines.forEach(line => {
                    if (line.startsWith('#EXTINF:')) {
                        // Extrai informações do canal
                        const info = line.split(',');
                        currentChannel.name = info[1];
                        
                        // Extrai atributos (logo, id, etc.)
                        const attrs = info[0].match(/tvg-([^=]+)="([^"]+)"/g);
                        if (attrs) {
                            attrs.forEach(attr => {
                                const [key, value] = attr.replace(/"/g, '').split('=');
                                currentChannel[key] = value;
                            });
                        }
                    } else if (line.startsWith('http')) {
                        currentChannel.url = line.trim();
                        this.createChannelCard(currentChannel);
                        currentChannel = {};
                    }
                });
            },
            
            createChannelCard(channel) {
                const channelList = document.getElementById('channelList');
                const card = document.createElement('div');
                card.className = 'channel-card';
                card.onclick = () => this.playChannel(channel.url);
                
                const logo = channel['tvg-logo'] ? 
                    `<img src="${channel['tvg-logo']}" alt="${channel.name}" class="channel-logo">` : 
                    `<div class="channel-logo" style="display:flex;align-items:center;justify-content:center;background:#eee;color:#333;">${channel.name}</div>`;
                
                card.innerHTML = `
                    ${logo}
                    <h3 style="margin:10px 0;text-align:center;">${channel.name}</h3>
                `;
                
                if (channel['tvg-group']) {
                    card.dataset.category = channel['tvg-group'].toLowerCase();
                }
                
                channelList.appendChild(card);
            },
            
            playChannel(url) {
                const videoPlayer = document.getElementById('videoPlayer');
                
                // Para qualquer reprodução atual
                videoPlayer.pause();
                
                // Verifica se é HLS
                if (url.includes('.m3u8')) {
                    if (Hls.isSupported()) {
                        const hls = new Hls();
                        hls.loadSource(url);
                        hls.attachMedia(videoPlayer);
                        hls.on(Hls.Events.MANIFEST_PARSED, () => {
                            videoPlayer.play();
                        });
                    } else if (videoPlayer.canPlayType('application/vnd.apple.mpegurl')) {
                        // Safari suporta HLS nativamente
                        videoPlayer.src = url;
                        videoPlayer.play();
                    } else {
                        this.showMessage('Seu navegador não suporta este formato de vídeo');
                    }
                } else {
                    // Outros formatos (MP4, TS, etc.)
                    videoPlayer.src = url;
                    videoPlayer.play();
                }
            },
            
            async loadCategories(username, password) {
                try {
                    const apiUrl = `${this.config.protocol}${this.config.server}:${this.config.port}/player_api.php?username=${username}&password=${password}&action=get_live_categories`;
                    const response = await fetch(apiUrl);
                    const categories = await response.json();
                    
                    const filter = document.getElementById('categoryFilter');
                    
                    categories.forEach(cat => {
                        const option = document.createElement('option');
                        option.value = cat.category_name.toLowerCase();
                        option.textContent = cat.category_name;
                        filter.appendChild(option);
                    });
                } catch (error) {
                    console.error('Erro ao carregar categorias:', error);
                }
            },
            
            filterChannels() {
                const category = document.getElementById('categoryFilter').value;
                const cards = document.querySelectorAll('.channel-card');
                
                cards.forEach(card => {
                    if (category === 'all' || card.dataset.category === category) {
                        card.style.display = 'block';
                    } else {
                        card.style.display = 'none';
                    }
                });
            },
            
            showMessage(msg, color = 'red') {
                const msgEl = document.getElementById('loginMessage');
                msgEl.textContent = msg;
                msgEl.style.color = color;
            },
            
            logout() {
                localStorage.removeItem('iptv_username');
                document.getElementById('loginSection').style.display = 'block';
                document.getElementById('playerSection').style.display = 'none';
                document.getElementById('username').value = '';
                document.getElementById('password').value = '';
                document.getElementById('videoPlayer').src = '';
            }
        };
        
        // Inicializa quando o DOM estiver pronto
        document.addEventListener('DOMContentLoaded', () => IPTV_PLAYER.init());
    </script>
</body>
</html>
